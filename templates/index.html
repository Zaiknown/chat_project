{% extends 'base.html' %}
{% load static %}

{% block title %}ZK's Chat{% endblock %}

{% block content %}
<div class="lobby-container">
    <div class="room-list-card">
        <div class="nav-tabs">
            <button class="tab-link active" onclick="openTab(event, 'public-rooms')">Salas Públicas</button>
            <button class="tab-link" onclick="openTab(event, 'private-chats')">Conversas</button>
        </div>

        <div id="public-rooms" class="tab-content active">
            <ul id="room-list" class="room-list">
                {% for room in public_rooms %}
                    <li class="room-list-item">
                        {% if room.slug in joined_rooms %}
                            <a href="{% url 'chat:chat_room' room.slug %}" class="btn join-leave-btn">Entrar na Sala</a>
                        {% else %}
                            <a href="{% url 'chat:join_room' room.slug %}" class="btn join-leave-btn">Participar do Chat</a>
                        {% endif %}
                        <span class="room-name">{{ room.name }}</span>
                        <span class="room-meta">
                            <span class="room-user-count" data-room-slug="{{ room.slug }}"><i class="fas fa-user"></i> {{ room.user_count }}</span>
                            {% if room.password %}<i class="fas fa-lock room-lock-icon"></i>{% endif %}
                        </span>
                        
                        {% if request.user == room.creator %}
                            <form action="{% url 'chat:delete-room' room.slug %}" method="POST" onsubmit="return confirm('Tem certeza que deseja deletar esta sala?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-delete-room" title="Deletar Sala">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        {% endif %}
                    </li>
                {% empty %}
                    <li class="empty-list-message">Nenhuma sala pública criada.</li>
                {% endfor %}
            </ul>
        </div>

        <div id="private-chats" class="tab-content">
            <ul id="dm-list" class="dm-list">
                {% for profile in private_chats %}
                    <li class="dm-list-item">
                        {% with profile.user.username as other_username %}
                            <a href="{% url 'chat:start-dm' other_username %}" class="room-link">
                                <div class="dm-link-container">
                                    <img src="{{ profile.avatar.url }}" class="chat-avatar dm-avatar">
                                    <span>{{ other_username }}</span>
                                </div>
                            </a>
                        {% endwith %}
                    </li>
                {% empty %}
                    <li class="empty-list-message">Nenhuma conversa privada iniciada.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="create-room-card">
        <h2>Criar Nova Sala Pública</h2>
        <form method="POST" novalidate>
            {% csrf_token %}
            {% for field in form %}
                <div class="form-group">
                    {{ field.label_tag }}
                    {{ field }}
                </div>
            {% endfor %}
            {% if form.errors %}
                {% for field in form %}{% for error in field.errors %}
                    <div class="form-error">{{ error }}</div>
                {% endfor %}{% endfor %}
            {% endif %}
            <button type="submit" class="btn btn-create-room">Criar Sala</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        document.addEventListener('DOMContentLoaded', function() {
            const formFields = document.querySelectorAll('.create-room-card form input');
            formFields.forEach(field => {
                if (field.type !== 'checkbox' && field.type !== 'radio' && field.type !== 'file') {
                    field.classList.add('form-control');
                }
            });

            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const lobbySocket = new WebSocket(`${protocol}://${window.location.host}/ws/lobby/`);

            lobbySocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                if (data.type === 'user_count_update') {
                    const roomSlug = data.room_slug;
                    const userCount = data.user_count;
                    const userCountElement = document.querySelector(`.room-user-count[data-room-slug="${roomSlug}"]`);
                    if (userCountElement) {
                        userCountElement.innerHTML = `<i class="fas fa-user"></i> ${userCount}`;
                    }
                }
            };

            lobbySocket.onclose = function(e) {
                console.error('Lobby socket closed unexpectedly');
            };
        });
    </script>
{% endblock %}